/**
 * Export utilities for setlist predictions
 */

import type { SetlistPrediction, Performance } from '~/types/setlist-prediction';
import { isSongItem } from '~/types/setlist-prediction';

// ==================== JSON Export ====================

export function exportAsJSON(prediction: SetlistPrediction): Blob {
  const json = JSON.stringify(prediction, null, 2);
  return new Blob([json], { type: 'application/json' });
}

export function downloadJSON(prediction: SetlistPrediction, filename?: string): void {
  const blob = exportAsJSON(prediction);
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename || `prediction-${prediction.id}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ==================== Text Export ====================

export function exportAsText(
  prediction: SetlistPrediction,
  performance?: Performance,
  authorName?: string
): string {
  const lines: string[] = [];

  // Header
  lines.push('═══════════════════════════════════════');
  lines.push('   SETLIST PREDICTION');
  lines.push('═══════════════════════════════════════');
  lines.push('');

  // Performance info
  if (performance) {
    lines.push(`Performance: ${performance.name}`);
    lines.push(`Date: ${performance.date}`);
    if (performance.venue) {
      lines.push(`Venue: ${performance.venue}`);
    }
    lines.push('');
  } else if (prediction.customPerformance) {
    lines.push(`Performance: ${prediction.customPerformance.name}`);
    if (prediction.customPerformance.date) {
      lines.push(`Date: ${prediction.customPerformance.date}`);
    }
    if (prediction.customPerformance.venue) {
      lines.push(`Venue: ${prediction.customPerformance.venue}`);
    }
    lines.push('');
  }

  // Prediction info
  lines.push(`Prediction: ${prediction.name}`);
  if (authorName) {
    lines.push(`Predicted by: ${authorName}`);
  }
  if (prediction.description) {
    lines.push(`Description: ${prediction.description}`);
  }
  lines.push(`Created: ${new Date(prediction.createdAt).toLocaleString()}`);
  lines.push('');
  lines.push('───────────────────────────────────────');
  lines.push('');

  // Setlist
  for (let i = 0; i < prediction.setlist.items.length; i++) {
    const item = prediction.setlist.items[i];

    // Format item
    const position = `${i + 1}.`.padEnd(4);
    let itemText = '';

    if (isSongItem(item)) {
      itemText = `♪ ${item.songId}`;
      if (item.isCustomSong && item.customSongName) {
        itemText = `♪ ${item.customSongName}`;
      }
    } else {
      itemText = `  [${item.title}]`;
    }

    let line = `${position}${itemText}`;

    // Add remarks
    if (item.remarks) {
      line += ` (${item.remarks})`;
    }

    lines.push(line);
  }

  // Footer
  lines.push('');
  lines.push('───────────────────────────────────────');
  lines.push(`Total Songs: ${prediction.setlist.items.filter(isSongItem).length}`);
  lines.push('');
  lines.push('Generated by LoveLive! Setlist Predictor');
  lines.push('───────────────────────────────────────');

  return lines.join('\n');
}

export function copyTextToClipboard(
  prediction: SetlistPrediction,
  performance?: Performance,
  authorName?: string
): Promise<void> {
  const text = exportAsText(prediction, performance, authorName);

  if (navigator.clipboard && navigator.clipboard.writeText) {
    return navigator.clipboard.writeText(text);
  } else {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = text;
    textarea.style.position = 'fixed';
    textarea.style.opacity = '0';
    document.body.appendChild(textarea);
    textarea.focus();
    textarea.select();

    try {
      document.execCommand('copy');
      document.body.removeChild(textarea);
      return Promise.resolve();
    } catch (err) {
      document.body.removeChild(textarea);
      return Promise.reject(new Error(err instanceof Error ? err.message : String(err)));
    }
  }
}

// ==================== Markdown Export ====================

export function exportAsMarkdown(prediction: SetlistPrediction, performance?: Performance): string {
  const lines: string[] = [];

  // Header
  lines.push('# Setlist Prediction');
  lines.push('');

  // Performance info
  if (performance) {
    lines.push(`## ${performance.name}`);
    lines.push('');
    lines.push(`**Date:** ${performance.date}`);
    if (performance.venue) {
      lines.push(`**Venue:** ${performance.venue}`);
    }
    lines.push('');
  }

  // Prediction info
  lines.push(`### ${prediction.name}`);
  if (prediction.description) {
    lines.push('');
    lines.push(prediction.description);
  }
  lines.push('');
  lines.push('---');
  lines.push('');

  // Setlist
  for (let i = 0; i < prediction.setlist.items.length; i++) {
    const item = prediction.setlist.items[i];

    // Format item
    let itemText = '';

    if (isSongItem(item)) {
      itemText = item.songId;
      if (item.isCustomSong && item.customSongName) {
        itemText = item.customSongName;
      }
    } else {
      itemText = `*${item.title}*`;
    }

    let line = `${i + 1}. ${itemText}`;

    // Add remarks
    if (item.remarks) {
      line += ` *(${item.remarks})*`;
    }

    lines.push(line);
  }

  // Footer
  lines.push('');
  lines.push('---');
  lines.push('');
  lines.push(`**Total Songs:** ${prediction.setlist.items.filter(isSongItem).length}`);
  lines.push('');
  lines.push('*Generated by LoveLive! Setlist Predictor*');

  return lines.join('\n');
}

// ==================== CSV Export ====================

export function exportAsCSV(prediction: SetlistPrediction): string {
  const lines: string[] = [];

  // Header
  lines.push('Position,Type,Song ID,Title,Remarks');

  // Items
  for (const item of prediction.setlist.items) {
    const position = item.position + 1;
    const type = item.type;
    const songId = isSongItem(item) ? item.songId : '';
    const title = isSongItem(item)
      ? item.isCustomSong
        ? item.customSongName || ''
        : ''
      : item.title;
    const remarks = item.remarks || '';

    lines.push(`${position},"${type}","${songId}","${title}","${remarks}"`);
  }

  return lines.join('\n');
}

export function downloadCSV(prediction: SetlistPrediction, filename?: string): void {
  const csv = exportAsCSV(prediction);
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename || `prediction-${prediction.id}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ==================== Helper Functions ====================

export function generateFilename(prediction: SetlistPrediction, extension: string): string {
  const safeName = prediction.name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
  const timestamp = new Date().toISOString().split('T')[0];
  return `${safeName}_${timestamp}.${extension}`;
}
